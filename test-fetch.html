<!DOCTYPE html>
<html>
<head>
    <title>Fetch Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>GAS API Fetch 診斷</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = msg;
            output.appendChild(div);
            console.log(msg);
        }

        async function testFetch() {
            const apiUrl = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
            const token = "YOUR_API_TOKEN";

            log(`1. Testing /health endpoint...`, 'info');
            log(`URL: ${apiUrl}?path=health&token=${token.substring(0, 10)}...`, 'info');

            try {
                const response = await fetch(`${apiUrl}?path=health&token=${token}`, {
                    method: 'GET'
                });

                log(`Response Status: ${response.status}`, 'info');
                log(`Response Headers:`, 'info');
                for (const [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }

                const text = await response.text();
                log(`Response Body: ${text}`, response.ok ? 'success' : 'error');

                try {
                    const json = JSON.parse(text);
                    log(`Parsed JSON: ${JSON.stringify(json, null, 2)}`, 'success');
                } catch (e) {
                    log(`Failed to parse JSON: ${e.message}`, 'error');
                }

            } catch (error) {
                log(`Fetch Error: ${error.message}`, 'error');
                log(`Error Stack: ${error.stack}`, 'error');
            }

            log(`\n2. Testing /tasks endpoint...`, 'info');

            try {
                const response = await fetch(`${apiUrl}?path=tasks&token=${token}`, {
                    method: 'GET'
                });

                log(`Response Status: ${response.status}`, 'info');
                const text = await response.text();
                log(`Response Body Length: ${text.length} chars`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    try {
                        const json = JSON.parse(text);
                        log(`Parsed JSON - Tasks count: ${json.tasks?.length || 'N/A'}`, 'success');
                    } catch (e) {
                        log(`Failed to parse: ${e.message}`, 'error');
                    }
                }

            } catch (error) {
                log(`Fetch Error: ${error.message}`, 'error');
            }
        }

        window.addEventListener('DOMContentLoaded', testFetch);
    </script>
</body>
</html>
