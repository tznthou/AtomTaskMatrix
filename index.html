<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ✅ Content Security Policy - 防禦 XSS 攻擊（強化版本：移除 script-src 的 unsafe-inline） -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://script.googleusercontent.com;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://script.google.com https://script.googleusercontent.com https://generativelanguage.googleapis.com https://sheets.googleapis.com;
        base-uri 'self';
        form-action 'self';"
    >
    <title>Atomic Task Matrix</title>
    <!-- ⚠️ Tailwind CDN 不支持 SRI（需要 CORS 但 CDN 不允許） -->
    <!-- 建議：在生產環境改用自託管 Tailwind 或支持 SRI 的 CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <!-- ✅ Tailwind 配置已移至外部檔案（tailwind-config.js），符合 CSP 安全政策 -->
    <script src="tailwind-config.js"></script>
</head>
<body class="min-h-screen bg-base-bg text-base-text">
    <div class="flex min-h-screen flex-col">
        <header class="border-b border-base-border bg-white/80 backdrop-blur">
            <div class="mx-auto flex w-full max-w-6xl flex-col gap-5 px-6 py-6">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div class="flex items-center gap-3 rounded-xl border border-base-border bg-white px-4 py-3 shadow-card">
                        <span id="status-indicator" class="text-lg">🔴</span>
                        <div class="flex flex-col leading-tight">
                            <span id="status-text" class="text-sm text-brand-danger">尚未連線</span>
                            <span id="last-sync" class="text-xs text-base-subtle">最後同步: -</span>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-xs text-base-subtle">
                        <span class="inline-flex items-center gap-1 rounded-lg border border-base-border bg-white px-2 py-1 shadow-sm">
                            <kbd class="rounded bg-base-bg px-1.5 font-semibold text-base-text">Tab</kbd>
                            焦點
                        </span>
                        <span class="inline-flex items-center gap-1 rounded-lg border border-base-border bg-white px-2 py-1 shadow-sm">
                            <kbd class="rounded bg-base-bg px-1.5 font-semibold text-base-text">Enter</kbd>
                            專注/取消
                        </span>
                        <span class="inline-flex items-center gap-1 rounded-lg border border-base-border bg-white px-2 py-1 shadow-sm">
                            <kbd class="rounded bg-base-bg px-1.5 font-semibold text-base-text">Shift+A</kbd>
                            AI 拆解
                        </span>
                    </div>
                </div>

                <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                    <div class="flex items-center gap-4">
                        <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-brand-primary/10 text-2xl text-brand-primary shadow-card">⚛️</span>
                        <div class="space-y-1">
                            <h1 class="text-2xl font-semibold tracking-tight text-base-text sm:text-3xl">Atomic Task Matrix</h1>
                            <p class="text-sm text-base-subtle">完成比完美重要 · 把能量投入下一個可行動作</p>
                        </div>
                    </div>
                    <div class="flex w-full flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
                        <label class="relative flex flex-1 items-center">
                            <span class="absolute left-4 text-sm text-base-subtle">⌘K</span>
                            <input
                                type="search"
                                placeholder="搜尋任務或輸入指令"
                                class="w-full rounded-xl border border-base-border bg-white px-12 py-3 text-sm text-base-text shadow-card outline-none transition focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20"
                            >
                        </label>
                        <div class="flex items-center gap-2">
                            <button type="button" class="rounded-xl border border-base-border bg-white px-4 py-2 text-xs font-semibold text-base-subtle shadow-sm transition hover:border-brand-accent hover:text-brand-primary">亮/暗</button>
                            <button type="button" class="rounded-xl border border-base-border bg-white px-4 py-2 text-xs font-semibold text-base-subtle shadow-sm transition hover:border-brand-accent hover:text-brand-primary">偏好設定</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1">
            <section class="mx-auto w-full max-w-6xl space-y-6 px-6 py-8">
                <div class="rounded-2xl border border-base-border bg-white p-6 shadow-elevation">
                    <form id="task-form" class="flex flex-col gap-4 lg:flex-row lg:items-center">
                        <div class="w-full lg:flex-1">
                            <label for="task-input" class="sr-only">建立新任務</label>
                            <div class="relative">
                                <span class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-base-subtle">+</span>
                                <input
                                    id="task-input"
                                    type="text"
                                    placeholder="輸入任務… 指令 /ai /due /tag"
                                    class="w-full rounded-xl border border-base-border bg-white px-11 py-3 text-sm text-base-text shadow-card outline-none transition focus:border-brand-primary focus:ring-2 focus:ring-brand-primary/20"
                                    autocomplete="off"
                                >
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <button
                                type="submit"
                                class="inline-flex items-center gap-2 rounded-xl bg-brand-primary px-5 py-3 text-sm font-semibold text-white shadow-card transition hover:bg-brand-accent focus:outline-none focus:ring-2 focus:ring-brand-primary/20"
                            >
                                建立任務
                            </button>
                            <div class="flex items-center gap-2 text-xs text-base-subtle">
                                <span class="rounded-lg bg-base-bg px-2 py-1 font-medium text-brand-primary shadow-sm">/ai</span>
                                <span>呼叫原子拆解</span>
                                <span class="rounded-lg bg-base-bg px-2 py-1 font-medium text-brand-primary shadow-sm">/due</span>
                                <span>設定截止</span>
                            </div>
                        </div>
                    </form>
                    <p id="task-feedback" class="mt-3 text-sm text-brand-accent opacity-0 transition-opacity duration-200">任務新增成功</p>
                </div>

                <div class="grid gap-6 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
                    <section class="space-y-6">
                        <div class="rounded-2xl border border-dashed border-brand-accent/40 bg-white p-6 shadow-card">
                            <div class="flex items-center justify-between gap-4">
                                <div>
                                    <h2 class="text-sm font-semibold text-brand-accent">待分類區</h2>
                                    <p class="text-xs text-base-subtle">新任務先進入緩衝區，思考後再派位</p>
                                </div>
                                <span class="rounded-full border border-brand-accent/30 bg-brand-accent/10 px-3 py-1 text-xs text-brand-accent">拖曳或點擊快速分類</span>
                            </div>
                            <div
                                id="uncategorized-dropzone"
                                data-status="uncategorized"
                                class="mt-4 min-h-[200px] space-y-3 rounded-xl border border-base-border bg-base-bg/80 p-4 transition"
                            >
                                <p class="text-sm text-base-subtle">目前沒有任務，透過命令列加入第一個行動。</p>
                            </div>
                        </div>

                        <div class="grid gap-5 rounded-2xl border border-base-border bg-white p-6 shadow-elevation lg:grid-cols-2">
                            <article class="flex flex-col gap-3 rounded-2xl border border-rose-200/50 bg-rose-50 p-4">
                                <header class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-rose-600">重要且緊急</h3>
                                        <p class="text-xs text-rose-500">立即處理，避免延遲風險</p>
                                    </div>
                                    <span class="rounded-full border border-rose-400/40 bg-white px-2 py-0.5 text-[10px] text-rose-600" id="badge-q1">0 項</span>
                                </header>
                                <div
                                    id="quadrant-q1"
                                    data-status="urgent_important"
                                    class="quadrant-dropzone min-h-[180px] space-y-3 rounded-xl border border-dashed border-rose-300/60 bg-white p-3"
                                >
                                    <p class="text-xs text-rose-400">拖曳任務或使用 Shift+↑ 移動到此</p>
                                </div>
                            </article>

                            <article class="flex flex-col gap-3 rounded-2xl border border-emerald-200/50 bg-emerald-50 p-4">
                                <header class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-emerald-600">重要不緊急</h3>
                                        <p class="text-xs text-emerald-500">安排專注時間穩定推進</p>
                                    </div>
                                    <span class="rounded-full border border-emerald-400/40 bg-white px-2 py-0.5 text-[10px] text-emerald-600" id="badge-q2">0 項</span>
                                </header>
                                <div
                                    id="quadrant-q2"
                                    data-status="not_urgent_important"
                                    class="quadrant-dropzone min-h-[180px] space-y-3 rounded-xl border border-dashed border-emerald-300/60 bg-white p-3"
                                >
                                    <p class="text-xs text-emerald-500">拖曳任務或使用 Shift+→ 移動到此</p>
                                </div>
                            </article>

                            <article class="flex flex-col gap-3 rounded-2xl border border-amber-200/60 bg-amber-50 p-4">
                                <header class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-amber-600">緊急不重要</h3>
                                        <p class="text-xs text-amber-500">考慮委派或設定提醒</p>
                                    </div>
                                    <span class="rounded-full border border-amber-400/40 bg-white px-2 py-0.5 text-[10px] text-amber-600" id="badge-q3">0 項</span>
                                </header>
                                <div
                                    id="quadrant-q3"
                                    data-status="urgent_not_important"
                                    class="quadrant-dropzone min-h-[180px] space-y-3 rounded-xl border border-dashed border-amber-300/60 bg-white p-3"
                                >
                                    <p class="text-xs text-amber-500">拖曳任務或使用 Shift+← 移動到此</p>
                                </div>
                            </article>

                            <article class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                                <header class="flex items-start justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-slate-600">不緊急不重要</h3>
                                        <p class="text-xs text-slate-500">視情況延後或刪除</p>
                                    </div>
                                    <span class="rounded-full border border-slate-300 bg-white px-2 py-0.5 text-[10px] text-slate-600" id="badge-q4">0 項</span>
                                </header>
                                <div
                                    id="quadrant-q4"
                                    data-status="not_urgent_not_important"
                                    class="quadrant-dropzone min-h-[180px] space-y-3 rounded-xl border border-dashed border-slate-300 bg-white p-3"
                                >
                                    <p class="text-xs text-slate-500">拖曳任務或使用 Shift+↓ 移動到此</p>
                                </div>
                            </article>
                        </div>
                    </section>

                    <aside class="space-y-6">
                        <div class="rounded-2xl border border-base-border bg-white p-6 shadow-elevation">
                            <div class="flex items-center justify-between">
                                <h2 class="text-sm font-semibold text-base-text">本週動能</h2>
                                <button id="refresh-stats" class="text-xs text-brand-accent underline-offset-2 hover:underline">重新整理</button>
                            </div>
                            <div class="mt-4 flex flex-col gap-6 sm:flex-row sm:items-center">
                                <div class="relative flex items-center justify-center">
                                    <svg id="progress-ring" width="140" height="140" viewBox="0 0 120 120" class="drop-shadow-lg">
                                        <circle cx="60" cy="60" r="50" stroke="rgba(148,163,184,0.3)" stroke-width="10" fill="none" />
                                        <circle id="progress-ring-circle" cx="60" cy="60" r="50" stroke="#2563EB" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="314" class="transition-all duration-500 ease-out" />
                                    </svg>
                                    <div class="pointer-events-none absolute inset-0 flex flex-col items-center justify-center text-center">
                                        <span id="progress-ring-value" class="text-3xl font-semibold text-brand-primary">--%</span>
                                        <span class="text-xs text-base-subtle">完成率</span>
                                    </div>
                                </div>
                                <div class="flex-1 space-y-3 text-sm">
                                    <div>
                                        <p class="text-xs text-base-subtle">本週完成任務</p>
                                        <p id="stat-total-completed" class="text-lg font-semibold text-base-text">--</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-base-subtle">平均存活日</p>
                                        <p id="stat-avg-lifetime" class="text-lg font-semibold text-base-text">-- 天</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-base-subtle">拆解採納率</p>
                                        <p id="stat-adoption" class="text-lg font-semibold text-base-text">--%</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="focus-panel" class="rounded-2xl border border-base-border bg-white p-6 shadow-elevation">
                            <div id="focus-empty" class="space-y-3 text-sm text-base-subtle">
                                <h3 class="text-base font-semibold text-base-text">選取任務以聚焦</h3>
                                <p>點擊任務卡的「專注」或在鍵盤上按 Enter,集中處理細節與 AI 拆解。</p>
                                <ul class="space-y-1 text-xs">
                                    <li>• Shift + 方向鍵：快速變更象限</li>
                                    <li>• Enter：切換專注 / 取消專注</li>
                                    <li>• Shift + A：呼叫 AI 拆解</li>
                                </ul>
                            </div>

                            <div id="focus-detail" class="hidden space-y-5">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span id="focus-status" class="rounded-lg border border-brand-accent/40 bg-brand-accent/10 px-2 py-0.5 text-[11px] uppercase tracking-wide text-brand-accent">狀態</span>
                                            <span id="focus-parent" class="hidden rounded-lg border border-base-border bg-base-bg px-2 py-0.5 text-[11px] text-base-subtle"></span>
                                        </div>
                                        <h3 id="focus-title" class="text-lg font-semibold text-base-text"></h3>
                                        <p id="focus-meta" class="text-xs text-base-subtle"></p>
                                    </div>
                                    <button id="focus-cancel" class="text-xs text-base-subtle underline-offset-2 hover:text-base-text hover:underline">取消專注</button>
                                </div>

                                <div class="flex flex-wrap items-center gap-2">
                                    <button
                                        id="focus-ai"
                                        class="inline-flex items-center gap-2 rounded-xl border border-brand-accent/40 bg-brand-accent/10 px-4 py-2 text-xs font-semibold text-brand-accent transition hover:border-brand-accent hover:bg-brand-accent/20 hover:text-brand-primary"
                                    >
                                        <span class="text-lg leading-none">🤖</span>
                                        AI 拆解
                                    </button>
                                    <button
                                        id="focus-complete"
                                        class="inline-flex items-center gap-2 rounded-xl border border-brand-success/40 bg-brand-success/10 px-4 py-2 text-xs font-semibold text-brand-success transition hover:bg-brand-success/20 hover:text-brand-success"
                                    >
                                        ✓ 標記完成
                                    </button>
                                </div>

                                <div class="space-y-3">
                                    <h4 class="text-sm font-semibold text-base-text">子任務</h4>
                                    <ul id="focus-subtasks" class="space-y-2">
                                        <li class="text-xs text-base-subtle">尚未有子任務。使用 AI 拆解或手動建立。</li>
                                    </ul>
                                </div>

                                <div class="space-y-2 text-xs text-base-subtle">
                                    <p id="focus-created">建立於 --</p>
                                    <p id="focus-updated">最後更新 --</p>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </section>
        </main>

        <footer class="border-t border-base-border bg-white/60">
            <div class="mx-auto flex w-full max-w-6xl flex-wrap items-center justify-between gap-3 px-6 py-4 text-xs text-base-subtle">
                <span>Atomic Task Matrix · Brightstream © 2025</span>
                <span>快捷: Tab 焦點 · Enter 專注/取消 · Shift+A AI 拆解</span>
            </div>
        </footer>
    </div>

    <template id="task-card-template">
        <article class="task-card group relative rounded-2xl border border-base-border bg-white p-4 text-sm text-base-text shadow-card transition hover:border-brand-primary/50"
            draggable="true">
            <div class="absolute inset-x-0 top-0 h-0.5 w-full -translate-y-full bg-brand-primary/30 opacity-0 transition duration-200 group-hover:translate-y-0 group-hover:opacity-100"></div>
            <div class="flex items-start justify-between gap-3">
                <div class="space-y-1">
                    <p class="font-semibold leading-snug"></p>
                    <p class="text-xs text-base-subtle"></p>
                </div>
                <div class="flex flex-col gap-2 text-xs">
                    <button data-action="focus" class="rounded-lg border border-base-border bg-base-bg px-2 py-1 text-base-subtle transition hover:border-brand-accent hover:text-brand-primary">專注</button>
                    <button data-action="complete" class="rounded-lg border border-brand-success/40 bg-brand-success/10 px-2 py-1 text-brand-success transition hover:bg-brand-success/20 hover:text-brand-success">完成</button>
                    <button data-action="delete" class="rounded-lg border border-brand-danger/40 bg-brand-danger/10 px-2 py-1 text-brand-danger transition hover:bg-brand-danger/20 hover:text-brand-danger">刪除</button>
                </div>
            </div>
            <div class="mt-3 flex items-center justify-between text-xs text-base-subtle">
                <span class="inline-flex items-center gap-1">
                    <span class="h-1.5 w-1.5 rounded-full bg-brand-accent"></span>
                    <span class="status-label"></span>
                </span>
                <span class="created-at"></span>
            </div>
        </article>
    </template>

    <template id="focus-subtask-template">
        <li class="flex items-center justify-between rounded-xl border border-base-border bg-base-bg px-3 py-2 text-xs text-base-text">
            <div class="flex flex-col">
                <span class="font-medium text-base-text"></span>
                <span class="text-[11px] text-base-subtle"></span>
            </div>
            <button data-action="complete-subtask" class="rounded-lg border border-brand-success/40 bg-brand-success/10 px-2 py-1 text-[11px] text-brand-success transition hover:bg-brand-success/20 hover:text-brand-success">
                ✓ 完成
            </button>
        </li>
    </template>

    <script src="config.js" defer></script>
    <script src="main.js" defer></script>
</body>
</html>
